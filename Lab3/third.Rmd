# Часть первая

### Загрузка данных

```{r}
library(ggplot2)
library(memisc)
#library(DescTools)
library(broom)
library(caTools)
library(lmtest)
library(dplyr)
library(readxl)
mydata <- read.csv(file="abon.txt", sep='\t')
mydata
```

### Построение модели линейной регрессии

```{r}
set.seed(56)
split <- sample.split(mydata$Средняя.продолжительность.разговоров, SplitRatio = 0.75)
train <- subset(mydata, split == TRUE)
test <- subset(mydata, split == FALSE)
model_l <- lm(data = train, Среднемесячный.расход ~ Средняя.продолжительность.разговоров)
summary(model_l)
```

Таким образом, уравнение регрессии имеет вид:
y = -256.946 + 181.366 * x

### Коэффициенты детерминации

```{r}
summary(model_l)$r.squared
summary(model_l)$adj.r.squared
```

Коэффициенты детерминации немногим выше среднего, поэтому можно сказать о качестве подгонки выше среднего.

### Остаточная дисперсия

```{r}
summary(model_l)$sigma^2
```

### Проверка наличия линейной связи

H0 - линейная связь отсутствует
H1 - линейная связь присутствует

```{r}
qf(0.95, 1, model_l$df.residual) > 7453
```

Т.к. F расчетное больше F табличного, нулевая гипотеза отвергается.

### Различные параметры линейной регрессии

```{r}
glance(model_l)
```

### Проверка случайности остаточной компоненты

```{r}
plot(model_l$fitted.values, model_l$residuals)
qplot(x = model_l$residuals, y = model_l$fitted.values)
```

На графиках видно, что значения остатков распределены возле нуля, но большинство значений < 0.

### Проверка равенства нулю матожидания остатков

H0 - матожидание равно нулю
H1 - матожидание отличается от нуля

```{r}
mean(model_l$residuals)
```

```{r}
rse <- model_l$df.residual
a <- mean(model_l$residuals)
b <- sd(model_l$residuals, na.rm = FALSE)
n <- sqrt(rse + 1)
tm <- a / b * n
```

```{r}
tt <- qt(0.95, rse + 1)
abs(tm) < tt
```

Так как t расчетное меньше по модулю чем t табличное, то нулевая гипотеза о равенстве нулю матожидания принимается с вероятностью 0.95.

#№# Проверка на гетероскедастичность
H0 - гетероскедастичность отсутствует
H1 - гетероскедастичность присутствует

Проведем тест Бройша-Погана:

```{r}
bptest(model_l)
```

Так как p-value меньше 0.05, нулевая гипотеза отвергается, следовательно, гетероскедастичность присутствует.

Проведем тест Спирмена
H0 - коэффициент Спирмена незначим (отсутствует гетероскедастичность)
H1 - коэффициент Спирмена значим (присутствует гетероскедастичность)

```{r}
cor.test(train$Средняя.продолжительность.разговоров, model_l$residuals, method = "spearman")
```

Так как p-value меньше 0.05, нулевая гипотеза отвергается, следовательно, гетероскедастичность присутствует.

### Проверка автокорреляции остатков
H0 - автокорреляция остатков отсутствует (rho = 0)
H1 - наличие положительной или отрицательной автокорреляции (rho < 0 или rho > 0)

Проведем тесты Бройша-Годфри и Дарбина-Уотсона

```{r}
bgtest(model_l)
dwtest(model_l)
```

Так как значения p-value больше 0.05, нулевая гипотеза о отсутствии автокорреляции принимается.

### Проверка согласования остатков регрессии с нормальным распределением

```{r}
qqnorm(model_l$residuals)
```

```{r}
library(sm)
Z <- model_l$residuals
hist(Z)
sm.density(Z, model="Normal", xlab="Residual", ylab="Функция плотности распределения", xlim=c(-3000, 3000))
```

Рассмотрим тесты на нормальность распределения.

H0 - распределение является нормальным
H1 - распределение не является нормальным

Тест Колмогорова-Смирнова

```{r}
library(nortest)
lillie.test(Z)

```

Так как p-value меньше 0.05, нулевая гипотеза о нормальности распределения отвергается.

Тест Шапиро-Уилка

```{r}
sh <- model_l$residuals[1:4900]
shapiro.test(sh)
```

Так как p-value меньше 0.05, нулевая гипотеза о нормальности распределения отвергается.

### Прогнозирование значений по полученной модели на тестовой выборке

```{r}
test_l <- predict(model_l, test)
plot(test$Средняя.продолжительность.разговоров, test$Среднемесячный.расход)
lines(test$Средняя.продолжительность.разговоров, test_l, col = "red")
```

